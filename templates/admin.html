<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<title>Ù„ÙˆØ­Ø© Ø§Ù„Ø£Ø¯Ù…Ù† â€” Ø¹Ø±Ø¶ Ø§Ù„Ø·Ù„Ø¨Ø©</title>
<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">

<style>
body { font-family: 'Cairo', sans-serif; background: #f4f6f9; margin: 0; padding: 20px; color: #333; }
h1 { text-align: center; color: #1976d2; }

.filters { display: flex; gap: 15px; justify-content: center; margin-bottom: 25px; flex-wrap: wrap; }

select, button {
    padding: 10px 15px;
    border-radius: 8px;
    border: none;
    font-size: 16px;
    cursor: pointer;
    transition: 0.3s;
}

select { background: #e0e0e0; }
select:hover { background: #d5d5d5; }

button { background: #1976d2; color: white; }
button:hover { background: #0d47a1; }

#printBtn { background: #f57c00; }
#printBtn:hover { background: #ef6c00; }

.delete-btn { background: #e53935; padding: 6px 10px; font-size: 14px; }
.delete-btn:hover { background: #b71c1c; }

.edit-btn { background: #43a047; padding: 6px 10px; font-size: 14px; }
.edit-btn:hover { background: #2e7d32; }

.save-btn { background: #1976d2; padding: 6px 10px; font-size: 14px; display:none; }
.cancel-btn { background: #757575; padding: 6px 10px; font-size: 14px; display:none; }

table {
    width: 100%;
    border-collapse: collapse;
    margin-bottom: 35px;
    background: white;
    box-shadow: 0 3px 8px rgba(0,0,0,0.1);
    border-radius: 8px;
    overflow: hidden;
}

th, td { padding: 12px 15px; text-align: center; }
th { background: #1976d2; color: white; }
tr:nth-child(even) { background: #f1f1f1; }

.table-title { margin: 15px 0 5px 0; font-size: 18px; font-weight: bold; }

.editing-row {
    background-color: #fff9c4 !important;
    transition: 0.3s;
}

/* Ù†Ø§ÙØ°Ø© Ø§Ù„Ø­Ø°Ù */
#deleteModal {
    display: none;
    position: fixed;
    top: 0; left: 0; right:0; bottom:0;
    background: rgba(0,0,0,0.5);
    justify-content: center;
    align-items: center;
    z-index: 1000;
}
#deleteModal .modal-content {
    background: #ffeb3b;
    padding: 25px;
    border-radius: 12px;
    text-align: center;
    max-width: 400px;
    box-shadow: 0 8px 20px rgba(0,0,0,0.3);
    font-size: 18px;
    font-weight: bold;
}
#deleteModal .modal-content button {
    margin-top: 15px;
    padding: 10px 20px;
    font-size: 16px;
    font-weight: bold;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    transition: 0.3s;
}
#deleteConfirm { background: #e53935; color: white; }
#deleteConfirm:hover { background: #b71c1c; }
#deleteCancel { background: #757575; color: white; }
#deleteCancel:hover { background: #424242; }

/* Ø§Ù„ØªØ­Ø°ÙŠØ± Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© */
#arabicModal {
    display: none;
    position: fixed;
    top: 0; left: 0; right:0; bottom:0;
    background: rgba(0,0,0,0.5);
    justify-content: center;
    align-items: center;
    z-index: 1000;
}
#arabicModal .modal-content {
    background: #ffeb3b;
    padding: 25px;
    border-radius: 12px;
    text-align: center;
    max-width: 400px;
    box-shadow: 0 8px 20px rgba(0,0,0,0.3);
    font-size: 18px;
    font-weight: bold;
}
#arabicModal .modal-content button {
    margin-top: 15px;
    padding: 10px 20px;
    font-size: 16px;
    font-weight: bold;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    transition: 0.3s;
    background: #f44336;
    color: white;
}
#arabicModal .modal-content button:hover {
    background: #d32f2f;
}

/* Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© */
@media print {
    body * { visibility: hidden; }
    #tablesContainer, #tablesContainer * { visibility: visible; }
    #tablesContainer { position: absolute; left: 0; top: 0; width: 100%; }
    th:last-child, td:last-child { display: none; }
}
</style>
</head>

<body>

<h1>Ù„ÙˆØ­Ø© Ø§Ù„Ø£Ø¯Ù…Ù† â€” Ø¹Ø±Ø¶ Ø§Ù„Ø·Ù„Ø¨Ø©</h1>

<div class="filters">
<select id="classFilter">
<option value="">Ø§Ø®ØªØ± Ø§Ù„Ù‚Ø³Ù…</option>
{% for c in classes %}
<option value="{{ c }}">{{ c }}</option>
{% endfor %}
</select>

<select id="groupFilter">
<option value="">Ø§Ø®ØªØ± Ø§Ù„ÙÙˆØ¬</option>
{% for g in groups %}
<option value="{{ g }}">{{ g }}</option>
{% endfor %}
</select>

<select id="semesterFilter">
<option value="">Ø§Ø®ØªØ± Ø§Ù„ÙØµÙ„</option>
<option value="1">Ø§Ù„ÙØµÙ„ Ø§Ù„Ø£ÙˆÙ„</option>
<option value="2">Ø§Ù„ÙØµÙ„ Ø§Ù„Ø«Ø§Ù†ÙŠ</option>
<option value="3">Ø§Ù„ÙØµÙ„ Ø§Ù„Ø«Ø§Ù„Ø«</option>
<option value="all">Ø§Ù„ÙƒÙ„</option>
</select>

<button onclick="applyFilter()">ÙÙ„ØªØ±Ø©</button>
<button onclick="showAll()">Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„ÙƒÙ„</button>
<button id="printBtn" onclick="printTables()">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø©</button>
</div>

<div id="tablesContainer">
{% for group_name, students in grouped.items() %}
<div class="table-wrapper"
     data-class="{{ group_name.split(' â€” ')[0] }}"
     data-group="{{ group_name.split(' â€” ')[1] }}">

<div class="table-title">{{ group_name }}</div>

<table>
<thead>
<tr>
<th>Ø§Ù„Ù„Ù‚Ø¨</th>
<th>Ø§Ù„Ø§Ø³Ù…</th>
<th>Ø§Ù„Ù‚Ø³Ù…</th>
<th>Ø§Ù„ÙÙˆØ¬</th>

{% if selected_semester %}
  {% if selected_semester == 'all' %}
  <th>ØªÙ‚ÙˆÙŠÙ…1</th><th>ÙØ±Ø¶1</th><th>Ø§Ø®ØªØ¨Ø§Ø±1</th>
  <th>ØªÙ‚ÙˆÙŠÙ…2</th><th>ÙØ±Ø¶2</th><th>Ø§Ø®ØªØ¨Ø§Ø±2</th>
  <th>ØªÙ‚ÙˆÙŠÙ…3</th><th>ÙØ±Ø¶3</th><th>Ø§Ø®ØªØ¨Ø§Ø±3</th>
  {% elif selected_semester == '1' %}
  <th>ØªÙ‚ÙˆÙŠÙ…1</th><th>ÙØ±Ø¶1</th><th>Ø§Ø®ØªØ¨Ø§Ø±1</th>
  {% elif selected_semester == '2' %}
  <th>ØªÙ‚ÙˆÙŠÙ…2</th><th>ÙØ±Ø¶2</th><th>Ø§Ø®ØªØ¨Ø§Ø±2</th>
  {% elif selected_semester == '3' %}
  <th>ØªÙ‚ÙˆÙŠÙ…3</th><th>ÙØ±Ø¶3</th><th>Ø§Ø®ØªØ¨Ø§Ø±3</th>
  {% endif %}
{% endif %}

<th>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
</tr>
</thead>

<tbody>
{% for s in students %}
<tr id="row-{{ s['_index'] }}">
<td>{{ s['last_name'] }}</td>
<td>{{ s['first_name'] }}</td>
<td data-value="{{ s['class'] }}">{{ s['class'] }}</td>
<td data-value="{{ s['group'] }}">{{ s['group'] }}</td>

{% if selected_semester %}
  {% if selected_semester == 'all' %}
  <td>{{ s['evaluation1'] }}</td><td>{{ s['test1'] }}</td><td>{{ s['exam1'] }}</td>
  <td>{{ s['evaluation2'] }}</td><td>{{ s['test2'] }}</td><td>{{ s['exam2'] }}</td>
  <td>{{ s['evaluation3'] }}</td><td>{{ s['test3'] }}</td><td>{{ s['exam3'] }}</td>
  {% elif selected_semester == '1' %}
  <td>{{ s['evaluation1'] }}</td><td>{{ s['test1'] }}</td><td>{{ s['exam1'] }}</td>
  {% elif selected_semester == '2' %}
  <td>{{ s['evaluation2'] }}</td><td>{{ s['test2'] }}</td><td>{{ s['exam2'] }}</td>
  {% elif selected_semester == '3' %}
  <td>{{ s['evaluation3'] }}</td><td>{{ s['test3'] }}</td><td>{{ s['exam3'] }}</td>
  {% endif %}
{% endif %}

<td>
<button class="edit-btn" onclick="editRow({{ s['_index'] }})">âœï¸ ØªØ¹Ø¯ÙŠÙ„</button>
<button class="delete-btn" onclick="showDeleteModal({{ s['_index'] }})">ğŸ—‘ Ø­Ø°Ù</button>
<button class="save-btn" onclick="saveRow({{ s['_index'] }})">ğŸ’¾ Ø­ÙØ¸</button>
<button class="cancel-btn" onclick="cancelEdit({{ s['_index'] }})">âŒ Ø¥Ù„ØºØ§Ø¡</button>
</td>
</tr>
{% endfor %}
</tbody>

</table>
</div>
{% endfor %}
</div>

<!-- Ù†Ø§ÙØ°Ø© Ø§Ù„Ø­Ø°Ù -->
<div id="deleteModal">
    <div class="modal-content">
        <h3>Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø·Ø§Ù„Ø¨ØŸ</h3>
        <div class="modal-buttons" style="display:flex; gap:15px; justify-content:center;">
            <button id="deleteConfirm">Ø­Ø°Ù âœ…</button>
            <button id="deleteCancel">Ø¥Ù„ØºØ§Ø¡ âŒ</button>
        </div>
    </div>
</div>

<!-- Ù†Ø§ÙØ°Ø© Ø§Ù„ØªØ­Ø°ÙŠØ± Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© -->
<div id="arabicModal">
    <div class="modal-content">
        Ø§Ù„Ø±Ø¬Ø§Ø¡ ÙƒØªØ§Ø¨Ø© Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø¨Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© ÙÙ‚Ø·! âŒ
        <br>
        <button onclick="closeArabicModal()">Ø¥ØºÙ„Ø§Ù‚</button>
    </div>
</div>

<script>
let currentEditing = null;
let currentIndex = null;
let selected_semester = "";

document.getElementById("semesterFilter").addEventListener("change", (e)=>{
    selected_semester = e.target.value;
    applyFilter();
});

// --- Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ ---
function editRow(index) {
    if(currentEditing !== null) return;
    const row = document.getElementById("row-" + index);
    const cells = row.querySelectorAll("td");
    row.classList.add("editing-row");
    currentEditing = index;

    cells.forEach((cell, i) => {
        if(i === 2){ // Ø§Ù„Ù‚Ø³Ù…
            const value = cell.dataset.value;
            const options = [{% for c in classes %}'{{ c }}',{% endfor %}];
            let select = `<select>`;
            options.forEach(opt => {
                select += `<option value="${opt}" ${opt===value?'selected':''}>${opt}</option>`;
            });
            select += `</select>`;
            cell.innerHTML = select;
        } else if(i === 3){ // Ø§Ù„ÙÙˆØ¬
            const value = cell.dataset.value;
            const options = [{% for g in groups %}'{{ g }}',{% endfor %}];
            let select = `<select>`;
            options.forEach(opt => {
                select += `<option value="${opt}" ${opt===value?'selected':''}>${opt}</option>`;
            });
            select += `</select>`;
            cell.innerHTML = select;
        } else if(i < cells.length -1){
            const text = cell.innerText;
            cell.innerHTML = `<input type="text" value="${text}" style="width:100%">`;
        }
    });
    toggleButtons(row, true);
}

function cancelEdit(index) {
    const row = document.getElementById("row-" + index);
    const cells = row.querySelectorAll("td");
    const inputs = row.querySelectorAll("input, select");
    inputs.forEach((input, i) => {
        if(input.tagName==='SELECT'){
            cells[i].innerText = input.options[input.selectedIndex].value;
        } else {
            cells[i].innerText = input.defaultValue;
        }
    });
    row.classList.remove("editing-row");
    toggleButtons(row, false);
    currentEditing = null;
}

function toggleButtons(row, editing) {
    const editBtn = row.querySelector(".edit-btn");
    const deleteBtn = row.querySelector(".delete-btn");
    const saveBtn = row.querySelector(".save-btn");
    const cancelBtn = row.querySelector(".cancel-btn");
    if(editing){
        editBtn.style.display = "none";
        deleteBtn.style.display = "none";
        saveBtn.style.display = "inline-block";
        cancelBtn.style.display = "inline-block";
    } else {
        editBtn.style.display = "inline-block";
        deleteBtn.style.display = "inline-block";
        saveBtn.style.display = "none";
        cancelBtn.style.display = "none";
    }
}

function isArabic(text){
    return /^[\u0600-\u06FF0-9\s]+$/.test(text);
}

function saveRow(index){
    const row = document.getElementById("row-" + index);
    const inputs = row.querySelectorAll("input, select");

    for(let i=0;i<inputs.length;i++){
        const input = inputs[i];
        if(input.tagName==='INPUT'){
            if(input.value && !isArabic(input.value)){
                document.getElementById("arabicModal").style.display = "flex";
                return;
            }
        }
    }

    const data = { index: index, last_name: inputs[0].value, first_name: inputs[1].value,
        class: inputs[2].value, group: inputs[3].value };

    {% for n in range(1,4) %}
        if(selected_semester=='all' || selected_semester=='{{ n }}'){
            if(selected_semester=='all' || selected_semester=='{{ n }}'){
                data['evaluation{{ n }}']=inputs[{{ 4+(n-1)*3 }}]?.value || '';
                data['test{{ n }}']=inputs[{{ 5+(n-1)*3 }}]?.value || '';
                data['exam{{ n }}']=inputs[{{ 6+(n-1)*3 }}]?.value || '';
            }
        }
    {% endfor %}

    fetch("/edit_student",{
        method:"POST",
        headers:{ "Content-Type":"application/x-www-form-urlencoded" },
        body:new URLSearchParams(data)
    }).then(res=>res.json()).then(resp=>{
        if(resp.status==="success"){
            const cells = row.querySelectorAll("td");
            cells[0].innerText = data.last_name;
            cells[1].innerText = data.first_name;
            cells[2].innerText = data.class;
            cells[3].innerText = data.group;

            {% for n in range(1,4) %}
                if(selected_semester=='all' || selected_semester=='{{ n }}'){
                    cells[{{ 4+(n-1)*3 }}].innerText = data['evaluation{{ n }}'];
                    cells[{{ 5+(n-1)*3 }}].innerText = data['test{{ n }}'];
                    cells[{{ 6+(n-1)*3 }}].innerText = data['exam{{ n }}'];
                }
            {% endfor %}

            row.classList.remove("editing-row");
            toggleButtons(row,false);
            currentEditing=null;
        }else{
            alert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø­ÙØ¸ âŒ");
        }
    });
}

function showDeleteModal(index){
    currentIndex=index;
    document.getElementById('deleteModal').style.display='flex';
}
document.getElementById('deleteCancel').addEventListener('click',()=>{
    document.getElementById('deleteModal').style.display='none';
});
document.getElementById('deleteConfirm').addEventListener('click',()=>{
    if(currentIndex!==null){
        fetch("/delete_student",{
            method:"POST",
            headers:{"Content-Type":"application/x-www-form-urlencoded"},
            body:"index="+currentIndex
        }).then(res=>res.json()).then(data=>{
            if(data.status==="success"){
                const row=document.getElementById("row-"+currentIndex);
                if(row) row.remove();
            }else{ alert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø­Ø°Ù âŒ"); }
            document.getElementById('deleteModal').style.display='none';
            currentIndex=null;
        });
    }
});

function applyFilter(){
    const classVal=document.getElementById("classFilter").value;
    const groupVal=document.getElementById("groupFilter").value;
    const semesterVal=document.getElementById("semesterFilter").value;

    document.querySelectorAll(".table-wrapper").forEach(t=>{
        t.style.display=
        ((classVal=="" || t.dataset.class===classVal) &&
         (groupVal=="" || t.dataset.group===groupVal))?"block":"none";

        // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ø¥Ø°Ø§ Ù„Ù… ÙŠØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ÙØµÙ„
        const showCols = semesterVal && semesterVal!="";
        const ths = t.querySelectorAll("th");
        const trs = t.querySelectorAll("tbody tr");
        if(!showCols){
            for(let i=4;i<ths.length-1;i++) ths[i].style.display="none";
            trs.forEach(tr=>{
                const tds = tr.querySelectorAll("td");
                for(let i=4;i<tds.length-1;i++) tds[i].style.display="none";
            });
        }else{
            for(let i=4;i<ths.length-1;i++) ths[i].style.display="";
            trs.forEach(tr=>{
                const tds = tr.querySelectorAll("td");
                for(let i=4;i<tds.length-1;i++) tds[i].style.display="";
            });
        }
    });
}

function showAll(){
    document.querySelectorAll(".table-wrapper").forEach(t=>t.style.display="block");
    document.getElementById("classFilter").value="";
    document.getElementById("groupFilter").value="";
    document.getElementById("semesterFilter").value="";
    applyFilter();
}

function printTables(){ window.print(); }
function closeArabicModal(){ document.getElementById("arabicModal").style.display="none"; }

</script>
</body>
</html>

