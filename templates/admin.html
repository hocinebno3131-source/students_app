<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<title>Ù„ÙˆØ­Ø© Ø§Ù„Ø£Ø¯Ù…Ù† â€” Ø¹Ø±Ø¶ Ø§Ù„Ø·Ù„Ø¨Ø©</title>
<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">

<style>
body { font-family: 'Cairo', sans-serif; background: #f4f6f9; margin: 0; padding: 20px; color: #333; }
h1 { text-align: center; color: #1976d2; }

.filters { display: flex; gap: 15px; justify-content: center; margin-bottom: 25px; flex-wrap: wrap; }

select, button {
    padding: 10px 15px;
    border-radius: 8px;
    border: none;
    font-size: 16px;
    cursor: pointer;
    transition: 0.3s;
}

select { background: #e0e0e0; }
select:hover { background: #d5d5d5; }

button { background: #1976d2; color: white; }
button:hover { background: #0d47a1; }

#printBtn { background: #f57c00; }
#printBtn:hover { background: #ef6c00; }

.delete-btn { background: #e53935; padding: 6px 10px; font-size: 14px; }
.delete-btn:hover { background: #b71c1c; }

.edit-btn { background: #43a047; padding: 6px 10px; font-size: 14px; }
.edit-btn:hover { background: #2e7d32; }

.save-btn { background: #1976d2; padding: 6px 10px; font-size: 14px; }
.cancel-btn { background: #757575; padding: 6px 10px; font-size: 14px; }

table {
    width: 100%;
    border-collapse: collapse;
    margin-bottom: 35px;
    background: white;
    box-shadow: 0 3px 8px rgba(0,0,0,0.1);
    border-radius: 8px;
    overflow: hidden;
}

th, td { padding: 12px 15px; text-align: center; }
th { background: #1976d2; color: white; }
tr:nth-child(even) { background: #f1f1f1; }

.table-title { margin: 15px 0 5px 0; font-size: 18px; font-weight: bold; }

/* ØµÙ ÙÙŠ ÙˆØ¶Ø¹ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ */
.editing-row {
    background-color: #fff9c4 !important;
    transition: 0.3s;
}

/* Ù†Ø§ÙØ°Ø© Ø§Ù„ØªØ­Ø°ÙŠØ± Ù„Ù„ÙƒØªØ§Ø¨Ø© ØºÙŠØ± Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© */
#arabicModal {
    display: none;
    position: fixed;
    top:0; left:0; right:0; bottom:0;
    background: rgba(0,0,0,0.5);
    justify-content: center;
    align-items: center;
    z-index: 1000;
}
#arabicModal .modal-content {
    background: #ffeb3b;
    padding: 25px;
    border-radius: 12px;
    text-align: center;
    max-width: 400px;
    font-size: 18px;
    font-weight: bold;
}
#arabicModal .modal-content button {
    margin-top: 15px;
    padding: 10px 20px;
    font-size: 16px;
    font-weight: bold;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    transition: 0.3s;
}
#arabicModal .modal-content button#closeModal {
    background: #f44336;
    color: white;
}
#arabicModal .modal-content button#closeModal:hover {
    background: #d32f2f;
}

/* Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© */
@media print {
    body * { visibility: hidden; }
    #tablesContainer, #tablesContainer * { visibility: visible; }
    #tablesContainer { position: absolute; left: 0; top: 0; width: 100%; }
    th:last-child, td:last-child { display: none; }
}
</style>
</head>

<body>

<h1>Ù„ÙˆØ­Ø© Ø§Ù„Ø£Ø¯Ù…Ù† â€” Ø¹Ø±Ø¶ Ø§Ù„Ø·Ù„Ø¨Ø©</h1>

<div class="filters">
<select id="classFilter">
<option value="">Ø§Ø®ØªØ± Ø§Ù„Ù‚Ø³Ù…</option>
{% for c in classes %}
<option value="{{ c }}">{{ c }}</option>
{% endfor %}
</select>

<select id="groupFilter">
<option value="">Ø§Ø®ØªØ± Ø§Ù„ÙÙˆØ¬</option>
{% for g in groups %}
<option value="{{ g }}">{{ g }}</option>
{% endfor %}
</select>

<button onclick="applyFilter()">ÙÙ„ØªØ±Ø©</button>
<button onclick="showAll()">Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„ÙƒÙ„</button>
<button id="printBtn" onclick="printTables()">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø©</button>
</div>

<div id="tablesContainer">
{% for group_name, students in grouped.items() %}
<div class="table-wrapper"
     data-class="{{ group_name.split(' â€” ')[0] }}"
     data-group="{{ group_name.split(' â€” ')[1] }}">

<div class="table-title">{{ group_name }}</div>

<table>
<thead>
<tr>
<th>Ø§Ù„Ù„Ù‚Ø¨</th>
<th>Ø§Ù„Ø§Ø³Ù…</th>
<th>Ø§Ù„Ù‚Ø³Ù…</th>
<th>Ø§Ù„ÙÙˆØ¬</th>
<th>Ø§Ù„Ù‡Ø§ØªÙ</th>
<th>Ù…Ù„Ø§Ø­Ø¸Ø©</th>
<th>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
</tr>
</thead>

<tbody>
{% for s in students %}
<tr id="row-{{ s['_index'] }}">
<td>{{ s['last_name'] }}</td>
<td>{{ s['first_name'] }}</td>
<td>{{ s['class'] }}</td>
<td>{{ s['group'] }}</td>
<td>{{ s['phone'] }}</td>
<td>{{ s['note'] }}</td>
<td>
<button class="edit-btn" onclick="editRow({{ s['_index'] }})">âœï¸ ØªØ¹Ø¯ÙŠÙ„</button>
<button class="delete-btn" onclick="showDeleteModal({{ s['_index'] }})">ğŸ—‘ Ø­Ø°Ù</button>
<button class="save-btn" style="display:none;" onclick="saveRow({{ s['_index'] }})">ğŸ’¾ Ø­ÙØ¸</button>
<button class="cancel-btn" style="display:none;" onclick="cancelEdit({{ s['_index'] }})">âŒ Ø¥Ù„ØºØ§Ø¡</button>
</td>
</tr>
{% endfor %}
</tbody>

</table>
</div>
{% endfor %}
</div>

<!-- Ù†Ø§ÙØ°Ø© Ø§Ù„ØªØ­Ø°ÙŠØ± Ù„Ù„ÙƒØªØ§Ø¨Ø© ØºÙŠØ± Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© -->
<div id="arabicModal">
    <div class="modal-content">
        Ø§Ù„Ø±Ø¬Ø§Ø¡ ÙƒØªØ§Ø¨Ø© Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø¨Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© ÙÙ‚Ø·! âŒ
        <br>
        <button id="closeModal" onclick="closeArabicModal()">Ø¥ØºÙ„Ø§Ù‚</button>
    </div>
</div>

<script>
let currentEditing = null;

function applyFilter() {
    const classVal = document.getElementById("classFilter").value;
    const groupVal = document.getElementById("groupFilter").value;
    document.querySelectorAll(".table-wrapper").forEach(t => {
        t.style.display =
        ((classVal === "" || t.dataset.class === classVal) &&
         (groupVal === "" || t.dataset.group === groupVal))
         ? "block" : "none";
    });
}

function showAll() {
    document.querySelectorAll(".table-wrapper").forEach(t => t.style.display="block");
    classFilter.value="";
    groupFilter.value="";
}

function printTables() {
    window.print();
}

// ----- Ø§Ù„Ø­Ø°Ù -----
let currentIndex = null;
function showDeleteModal(index) {
    currentIndex = index;
    document.getElementById('deleteModal').style.display = 'flex';
}
document.getElementById('deleteCancel')?.addEventListener('click', () => {
    document.getElementById('deleteModal').style.display = 'none';
});
document.getElementById('deleteConfirm')?.addEventListener('click', () => {
    if(currentIndex !== null) {
        fetch("/delete_student", {
            method: "POST",
            headers: { "Content-Type": "application/x-www-form-urlencoded" },
            body: "index=" + currentIndex
        })
        .then(res => res.json())
        .then(data => {
            if(data.status === "success") {
                const row = document.getElementById("row-" + currentIndex);
                if(row) row.remove();
            } else alert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø­Ø°Ù âŒ");
            document.getElementById('deleteModal').style.display = 'none';
            currentIndex = null;
        });
    }
});

// ----- Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ -----
function isArabic(text) {
    return /^[\u0600-\u06FF\s]+$/.test(text);
}

function editRow(index) {
    if(currentEditing !== null) return;

    const row = document.getElementById("row-" + index);
    const cells = row.querySelectorAll("td");
    row.classList.add("editing-row");
    currentEditing = index;

    for(let i = 0; i < cells.length - 1; i++) {
        const text = cells[i].innerText;
        cells[i].innerHTML = `<input type="text" value="${text}" style="width:100%">`;
    }

    toggleButtons(row, true);
}

function cancelEdit(index) {
    const row = document.getElementById("row-" + index);
    location.reload();
}

function toggleButtons(row, editing) {
    const editBtn = row.querySelector(".edit-btn");
    const deleteBtn = row.querySelector(".delete-btn");
    const saveBtn = row.querySelector(".save-btn");
    const cancelBtn = row.querySelector(".cancel-btn");

    if(editing){
        editBtn.style.display = "none";
        deleteBtn.style.display = "none";
        saveBtn.style.display = "inline-block";
        cancelBtn.style.display = "inline-block";
    } else {
        editBtn.style.display = "inline-block";
        deleteBtn.style.display = "inline-block";
        saveBtn.style.display = "none";
        cancelBtn.style.display = "none";
    }
}

function saveRow(index) {
    const row = document.getElementById("row-" + index);
    const inputs = row.querySelectorAll("input");

    for(const input of inputs){
        if(!isArabic(input.value.trim())){
            document.getElementById("arabicModal").style.display = "flex";
            return;
        }
    }

    // Ø¥Ø°Ø§ ÙƒÙ„ Ø´ÙŠØ¡ Ø¹Ø±Ø¨ÙŠØŒ ÙŠÙ…ÙƒÙ† Ø§Ù„Ø¢Ù† Ø§Ù„Ø±Ø¨Ø· Ù…Ø¹ Flask Ù„Ø§Ø­Ù‚Ø§Ù‹
    alert("Ø§Ù„Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ù‚Ø§Ø¯Ù…Ø© Ø³Ù†Ø±Ø¨Ø· Ø§Ù„Ø­ÙØ¸ Ø¨Ù€ Flask ğŸ”¥");
}

function closeArabicModal() {
    document.getElementById("arabicModal").style.display = "none";
}
</script>

</body>
</html>
